import os, time, subprocess, httpx, secrets, string, asyncio
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    Application, CommandHandler, MessageHandler,
    CallbackQueryHandler, ContextTypes, filters, ConversationHandler
)
from telethon import TelegramClient
from telethon.sessions import StringSession
from telethon.errors import SessionPasswordNeededError, PhoneCodeInvalidError

import config, db

# ================= Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª =================
BOT_TOKEN = config.BOT_TOKEN
ELEVEN_API_KEY = config.ELEVEN_API_KEY
ADMIN_IDS = [7190018043]
OWNER_USERNAME = "@PWEEP2"

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Telethon (Ù…Ù† Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„Ù…Ø·ÙˆØ±)
API_ID = config.API_ID
API_HASH = config.API_HASH

# ================= Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª =================
MODEL_V3_INTERNAL = "eleven_v3"
MODEL_V2_INTERNAL = "eleven_multilingual_v2"
TMP = "tmp"
os.makedirs(TMP, exist_ok=True)

START_CREDITS = 5000   
MAX_PREVIEW = 1        
PREVIEW_TEXT = "ØªÙ… Ø§Ù„Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø¨Ù†Ø¬Ø§Ø­."

# ================= Ø­Ø§Ù„Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Telethon) =================
PHONE, CODE, PASSWORD = range(3)

# ================= Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© =================
def to_wav(inp, out):
    subprocess.run(["ffmpeg", "-y", "-i", inp, "-ar", "44100", "-ac", "1", out], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)

async def create_voice(wav, name):
    async with httpx.AsyncClient(timeout=60) as c:
        with open(wav, "rb") as f:
            r = await c.post("https://api.elevenlabs.io/v1/voices/add", headers={"xi-api-key": ELEVEN_API_KEY}, files={"files": f}, data={"name": name, "description": "Cloned via Telegram Bot"})
    if r.status_code != 200: raise Exception(f"API Error: {r.text}")
    return r.json()["voice_id"]

async def delete_voice_from_api(voice_id):
    if not voice_id: return False
    async with httpx.AsyncClient(timeout=30) as c:
        r = await c.delete(f"https://api.elevenlabs.io/v1/voices/{voice_id}", headers={"xi-api-key": ELEVEN_API_KEY})
    return r.status_code == 200

async def tts(voice_id, text, model_id):
    async with httpx.AsyncClient(timeout=60) as c:
        settings = {"stability": 0.5, "similarity_boost": 0.75} if model_id == MODEL_V3_INTERNAL else {"stability": 0.5, "similarity_boost": 0.75, "style": 0.0, "use_speaker_boost": True}
        r = await c.post(f"https://api.elevenlabs.io/v1/text-to-speech/{voice_id}", headers={"xi-api-key": ELEVEN_API_KEY, "Content-Type": "application/json"}, json={"text": text, "model_id": model_id, "voice_settings": settings})
    if r.status_code != 200: raise Exception(f"TTS Error: {r.text}")
    return r.content

# ================= Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± Telethon (Userbot) =================
async def send_via_userbot(user_id, file_path, caption):
    user = db.get_user(user_id)
    # Ø§Ù„ØªØ­Ù‚Ù‚: ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù…Ø´ØªØ±ÙƒØ§Ù‹ ÙˆÙ„Ø¯ÙŠÙ‡ Ø¬Ù„Ø³Ø© Ù…Ø­ÙÙˆØ¸Ø©
    if not user or user[3] != 1 or not user[7]: 
        return False

    try:
        # Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ù Ù„Ù†ÙØ³Ù‡ (Saved Messages)
        async with TelegramClient(StringSession(user[7]), API_ID, API_HASH) as client:
            await client.send_file("me", file_path, caption=caption)
        return True
    except Exception as e:
        print(f"Telethon Error: {e}")
        return False

# ================= Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… =================
def get_main_menu(user):
    is_paid = (user[3] == 1)
    has_voice = (user[2] is not None and len(str(user[2])) > 5)
    has_session = (user[7] is not None) 

    keyboard = []

    if is_paid:
        # Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† VIP
        if has_voice:
            keyboard.append([InlineKeyboardButton("âœï¸ ØªØ­ÙˆÙŠÙ„ Ù†Øµ Ø¥Ù„Ù‰ ØµÙˆØª", callback_data="write_text")])

            # Ø²Ø± Ø§Ù„Ø±Ø¨Ø· ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†
            if has_session:
                keyboard.append([InlineKeyboardButton("âœ… Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø±Ø¨ÙˆØ· (Userbot Ù†Ø´Ø·)", callback_data="telethon_info")])
            else:
                keyboard.append([InlineKeyboardButton("ğŸ“± Ø±Ø¨Ø· Ø­Ø³Ø§Ø¨ÙŠ (Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø³Ø±ÙŠ)", callback_data="telethon_start")])
        else:
            keyboard.append([InlineKeyboardButton("ğŸ™ï¸ Ø§Ø³ØªÙ†Ø³Ø§Ø® ØµÙˆØªÙŠ (ØªØ«Ø¨ÙŠØª Ø¯Ø§Ø¦Ù…)", callback_data="try_clone")])
    else:
        # Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©
        if user[4] < MAX_PREVIEW:
            text_btn = "ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¬Ø±Ø¨Ø©" if has_voice else "ğŸ§ ØªØ¬Ø±Ø¨Ø© Ù…Ø¬Ø§Ù†ÙŠØ© (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)"
            keyboard.append([InlineKeyboardButton(text_btn, callback_data="try_clone")])
        else:
            keyboard.append([InlineKeyboardButton("â›” Ø§Ù†ØªÙ‡Øª Ø§Ù„ØªØ¬Ø±Ø¨Ø© (Ø§Ø´ØªØ±Ùƒ Ø§Ù„Ø¢Ù†)", callback_data="buy")])

    keyboard.append([
        InlineKeyboardButton("ğŸ“Š Ø§Ù„Ø±ØµÙŠØ¯", callback_data="balance"),
        InlineKeyboardButton("ğŸ“˜ ØªØ¹Ù„ÙŠÙ…Ø§Øª v3 ÙˆØ§Ù„Ù…Ø´Ø§Ø¹Ø±", callback_data="help")
    ])

    # Ø²Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¸Ø§Ù‡Ø±
    keyboard.append([InlineKeyboardButton("ğŸ›’ Ø´Ø±Ø§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ / ØªÙØ¹ÙŠÙ„ ÙƒÙˆØ¯", callback_data="buy")])

    return InlineKeyboardMarkup(keyboard)

def get_back_btn():
    return InlineKeyboardMarkup([[InlineKeyboardButton("ğŸ”™ Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", callback_data="back_home")]])

# ================= /start (Ø§Ù„Ù†Øµ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ Ø§Ù„Ù†Ø§Ø±ÙŠ ğŸ”¥) =================
async def start(update: Update, ctx: ContextTypes.DEFAULT_TYPE):
    uid = update.effective_user.id
    db.create_user(uid)
    user = db.get_user(uid)

    welcome_text = (
        "ğŸ”¥ **Ø¨ÙˆØª Ø§Ù„Ø´Ø¨Ø­ Ù„Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„Ø£ØµÙˆØ§Øª - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©** ğŸ™ï¸\n\n"
        "Ù…Ù„ÙŠØª Ù…Ù† Ø§Ù„Ø¨ÙˆØªØ§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©ØŸ ØªØ±ÙŠØ¯ Ø´ÙŠ **Ø­Ù‚ÙŠÙ‚ÙŠ**ØŸ\n"
        "Ø§Ù„ÙŠÙˆÙ… Ø¬Ø¨Ù†Ø§Ù„Ùƒ ØªÙ‚Ù†ÙŠØ© **V3 Ø§Ù„Ù…Ø±Ø¹Ø¨Ø©**.. Ù…Ùˆ Ø¨Ø³ ÙŠÙ‚Ù„Ø¯ ØµÙˆØªÙƒØŒ Ù‡Ø°Ø§ ÙŠØ³Ø±Ù‚ Ù†Ø¨Ø±ØªÙƒ ÙˆØ¥Ø­Ø³Ø§Ø³Ùƒ Ø¨Ø§Ù„Ù…Ù„ÙŠ!\n\n"
        "ğŸ‘ï¸ **Ø´Ù†Ùˆ ØªÙƒØ¯Ø± ØªØ³ÙˆÙŠØŸ**\n"
        "1ï¸âƒ£ **Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„Ù‡ÙˆÙŠØ©:** Ø¯Ø² Ø¨ØµÙ…Ø© ÙˆØ­Ø¯Ø©ØŒ ÙˆØ§Ù„Ø¨ÙˆØª Ø±Ø§Ø­ ÙŠØµÙŠØ± **Ø£Ù†Øª**.\n"
        "2ï¸âƒ£ **ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù…Ø´Ø§Ø¹Ø±:** Ø®Ù„ÙŠÙ‡ ÙŠØ¶Ø­ÙƒØŒ ÙŠÙ‡Ù…Ø³ØŒ ÙŠØ¹ØµØ¨.. ÙƒÙ„Ù‡ Ø¨ÙƒØªØ§Ø¨Ø© ÙƒÙŠØ¨ÙˆØ±Ø¯!\n"
        "3ï¸âƒ£ **Ø¨ØµÙ…Ø§Øª Ù„Ø§ ØªÙÙƒØ´Ù:** Ø¯Ø²Ù‡Ø§ Ù„Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ ÙˆÙ…Ø³ØªØ­ÙŠÙ„ ÙŠØ¹Ø±ÙÙˆÙ† Ø£Ù†Ù‡ Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ.\n\n"
        "ğŸ’ **Ù„Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† VIP:**\n"
        "â€¢ ØªØ«Ø¨ÙŠØª ØµÙˆØªÙƒ Ù„Ù„Ø£Ø¨Ø¯ (Ù…Ù„Ùƒ Ù„Ùƒ).\n"
        "â€¢ Ø±ØµÙŠØ¯ Ø¶Ø®Ù… Ù„Ù„ÙƒØªØ§Ø¨Ø©.\n"
        "â€¢ **Ù…ÙŠØ²Ø© Userbot Ø§Ù„Ø­ØµØ±ÙŠØ©:** Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù…Ù† Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø¨Ø§Ø´Ø±Ø©! ğŸ“±\n\n"
        "ğŸ‘‡ **Ù„Ø§ ØªØ¶ÙŠØ¹ ÙˆÙ‚ØªØŒ Ø¬Ø±Ø¨ Ø¨Ø¨Ù„Ø§Ø´ Ù…Ø±Ø© ÙˆØ­Ø¯Ø© ÙˆØ´ÙˆÙ Ø§Ù„Ø³Ø­Ø± Ø¨Ù†ÙØ³Ùƒ!**"
    )

    if update.callback_query:
        await update.callback_query.message.edit_text(welcome_text, reply_markup=get_main_menu(user), parse_mode="Markdown")
    else:
        await update.message.reply_text(welcome_text, reply_markup=get_main_menu(user), parse_mode="Markdown")

# ================= Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ§Ù„ØªÙ†Ù‚Ù„ =================
async def buttons(update: Update, ctx: ContextTypes.DEFAULT_TYPE):
    q = update.callback_query

    # Ù„Ø§ Ù†ØºÙ„Ù‚ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø²Ø± Ù‡Ùˆ Ø¨Ø¯Ø§ÙŠØ© Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    if q.data != "telethon_start":
        await q.answer()

    uid = q.from_user.id
    user = db.get_user(uid)

    if q.data == "back_home":
        ctx.user_data.clear()
        status = "ğŸ›ï¸ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"
        if user[3] == 1: status += "\nâœ… (Ø¨Ø§Ù‚Ø© VIP Ù…ÙØ¹Ù„Ø©)"
        # ğŸ”¥ ØªÙ… Ø­Ø°Ù parse_mode Ù„ØªØ¬Ù†Ø¨ BadRequest Error
        return await q.message.edit_text(status, reply_markup=get_main_menu(user))

    if q.data == "buy":
        return await q.message.edit_text(
            "ğŸ›’ **Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ù…Ø¯ÙÙˆØ¹ (VIP)**\n\n"
            "ğŸ“¦ **Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙˆØ© Ø§Ù„ÙƒØ§Ù…Ù„Ø©:**\n"
            f"â€¢ Ø±ØµÙŠØ¯ **{START_CREDITS} Ø­Ø±Ù** Ù„Ù„ÙƒØªØ§Ø¨Ø©.\n"
            "â€¢ ØªØ«Ø¨ÙŠØª ØµÙˆØªÙƒ Ø§Ù„Ù…Ø³ØªÙ†Ø³Ø® Ø¨Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ù….\n"
            "â€¢ **ÙØªØ­ Ù…ÙŠØ²Ø© Userbot:** Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ØµÙ…Ø§Øª ÙƒØ£Ù†Ù‡Ø§ Ù…Ù†Ùƒ.\n"
            "â€¢ Ø¯Ø¹Ù… ÙƒØ§Ù…Ù„ Ù„Ù…ÙˆØ¯ÙŠÙ„ V3 (Ù…Ø´Ø§Ø¹Ø± ÙˆØ¶Ø­Ùƒ).\n\n"
            "ğŸ’° **Ø§Ù„Ø³Ø¹Ø±:**\n"
            "â€¢ 10$ Ø±ØµÙŠØ¯ Ø¢Ø³ÙŠØ§ Ø³ÙŠÙ„\n"
            "â€¢ 6 USDT\n\n"
            f"ğŸ“© **Ù„Ø´Ø±Ø§Ø¡ ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„:** {OWNER_USERNAME}",
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("ğŸ”‘ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„", callback_data="enter_code")],
                [InlineKeyboardButton("ğŸ”™ Ø¹ÙˆØ¯Ø©", callback_data="back_home")]
            ]),
            parse_mode="Markdown"
        )

    if q.data == "telethon_info":
        return await q.message.edit_text(
            "âœ… **Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø±Ø¨ÙˆØ· ÙˆÙ…ÙØ¹Ù„ (Userbot Active)**\n\n"
            "Ø§Ù„Ø¢Ù† Ø£ÙŠ Ù†Øµ ØªØ­ÙˆÙ„Ù‡ Ù„ØµÙˆØªØŒ Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù†Ø³Ø®Ø© Ù…Ù†Ù‡ Ø¥Ù„Ù‰ **'Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©'** ÙÙŠ Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„Ø®Ø§ØµØŒ ÙˆÙƒØ£Ù†Ùƒ Ø£Ù†Øª Ù…Ù† Ø³Ø¬Ù„Ù‡Ø§.\n\n"
            "ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡Ù‡Ø§ Ù„Ø£ÙŠ Ø´Ø®Øµ ÙˆÙ„Ù† ÙŠØ¸Ù‡Ø± Ø¹Ù„ÙŠÙ‡Ø§ 'Forwarded from Bot'.",
            reply_markup=get_back_btn(), parse_mode="Markdown"
        )

    # --- Ø§Ù„Ø§Ø³ØªÙ†Ø³Ø§Ø® ---
    if q.data == "try_clone":
        if user[3] == 1 and user[2]:
            return await q.message.edit_text("ğŸ”’ **Ù„Ø¯ÙŠÙƒ ØµÙˆØª Ù…Ø«Ø¨Øª Ø¨Ø§Ù„ÙØ¹Ù„.**", reply_markup=get_back_btn(), parse_mode="Markdown")

        if user[3] == 0 and user[4] >= MAX_PREVIEW:
            return await q.message.edit_text(
                "â›” **Ø§Ù†ØªÙ‡Øª Ø§Ù„ØªØ¬Ø±Ø¨Ø©.**\n"
                "ÙŠØ§ Ø¨Ø·Ù„ØŒ Ø®Ù„ØµØª ØªØ¬Ø±Ø¨ØªÙƒ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©.\n"
                "ØªØ±ÙŠØ¯ ØµÙˆØª Ø¯Ø§Ø¦Ù… ÙˆØ±ØµÙŠØ¯ Ø¶Ø®Ù… ÙˆÙ…ÙŠØ²Ø© UserbotØŸ Ø§Ø´ØªØ±Ùƒ ÙˆÙŠØ§Ù†Ø§.",
                reply_markup=InlineKeyboardMarkup([
                    [InlineKeyboardButton("ğŸ›’ Ø´Ø±Ø§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ", callback_data="buy")],
                    [InlineKeyboardButton("ğŸ”™ Ø¹ÙˆØ¯Ø©", callback_data="back_home")]
                ]),
                parse_mode="Markdown"
            )

        if user[3] == 1:
            return await q.message.edit_text(
                "âš ï¸ **ØªÙ†Ø¨ÙŠÙ‡ Ù‡Ø§Ù… Ù„Ù„Ù…Ø´ØªØ±Ùƒ**\n"
                "Ø±Ø§Ø­ ØªØ³Ø¬Ù„ ØµÙˆØªÙƒ **Ø§Ù„Ø¯Ø§Ø¦Ù…** Ù‡Ø³Ù‡.\n"
                "ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ Ø¨Ù…ÙƒØ§Ù† Ù‡Ø§Ø¯Ø¦ØŒ Ù„Ø£Ù† Ù‡Ø°Ø§ Ø§Ù„ØµÙˆØª Ø±Ø§Ø­ ÙŠØ«Ø¨Øª Ø¨Ø­Ø³Ø§Ø¨Ùƒ.\n"
                "Ø¬Ø§Ù‡Ø²ØŸ",
                reply_markup=InlineKeyboardMarkup([
                    [InlineKeyboardButton("âœ… Ù†Ø¹Ù…ØŒ Ø§Ø¨Ø¯Ø£", callback_data="select_model_clone")],
                    [InlineKeyboardButton("âŒ Ø¥Ù„ØºØ§Ø¡", callback_data="back_home")]
                ]),
                parse_mode="Markdown"
            )

        return await show_model_selection(q, "clone")

    if q.data == "select_model_clone":
        return await show_model_selection(q, "clone")

    if q.data.startswith("set_model_"):
        model_choice = q.data.split("_")[2]
        ctx.user_data["selected_model"] = MODEL_V3_INTERNAL if model_choice == "v3" else MODEL_V2_INTERNAL

        display_name = "v3" if model_choice == "v3" else "v2"
        return await q.message.edit_text(
            f"âœ… ØªÙ… Ø§Ø®ØªÙŠØ§Ø±: **{display_name}**\n\n"
            "ğŸ™ï¸ **Ø§Ù„Ø¢Ù†ØŒ Ø¯Ø² Ø¨ØµÙ…Ø© ØµÙˆØªÙŠØ© Ø£Ùˆ Ù…Ù„Ù MP3.**\n"
            "ğŸ’¡ Ù†ØµÙŠØ­Ø©: Ø£Ø­Ø¬ÙŠ Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ Ù„Ù…Ø¯Ø© 30-60 Ø«Ø§Ù†ÙŠØ© Ù„Ù†ØªÙŠØ¬Ø© Ø®Ø±Ø§ÙÙŠØ©.",
            reply_markup=get_back_btn(),
            parse_mode="Markdown"
        )

    # --- Ø§Ù„ÙƒØªØ§Ø¨Ø© ---
    if q.data == "write_text":
        if not user[2]: return await q.message.edit_text("âš ï¸ ÙŠØ¬Ø¨ Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„ØµÙˆØª Ø£ÙˆÙ„Ø§Ù‹.", reply_markup=get_back_btn())
        return await show_model_selection(q, "write")

    if q.data.startswith("use_model_"):
        model_choice = q.data.split("_")[2]
        ctx.user_data["selected_model"] = MODEL_V3_INTERNAL if model_choice == "v3" else MODEL_V2_INTERNAL
        ctx.user_data["awaiting_text"] = True

        display_name = "v3 (Ù…Ø´Ø§Ø¹Ø±)" if model_choice == "v3" else "v2 (Ù‚ÙŠØ§Ø³ÙŠ)"
        return await q.message.edit_text(
            f"âœ… Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„: **{display_name}**\n\nâœï¸ **Ø£ÙƒØªØ¨ Ø£ÙŠ Ø´ÙŠØŒ ÙˆØ§Ù„Ø¨ÙˆØª Ø±Ø§Ø­ ÙŠØ­Ø¬ÙŠÙ‡ Ø¨ØµÙˆØªÙƒ:**",
            reply_markup=get_back_btn(),
            parse_mode="Markdown"
        )

    if q.data == "enter_code":
        ctx.user_data["awaiting_code"] = True
        return await q.message.edit_text("ğŸ”‘ **Ø£Ø±Ø³Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„:**", reply_markup=get_back_btn(), parse_mode="Markdown")

    if q.data == "balance":
        return await q.message.edit_text(f"ğŸ’³ **Ø§Ù„Ø±ØµÙŠØ¯:** `{user[5]}` Ø­Ø±Ù", reply_markup=get_back_btn(), parse_mode="Markdown")

    if q.data == "help":
         return await q.message.edit_text(
             "ğŸ“˜ **Ø§Ù„Ø£Ø³Ø±Ø§Ø± Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ø­ØªØ±Ø§ÙÙŠØ©:**\n\n"
             "ğŸš€ **Ù…ÙˆØ¯ÙŠÙ„ v3 (Ø§Ù„Ø³Ø­Ø±ÙŠ):**\n"
             "Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ ÙŠÙÙ‡Ù… Ø§Ù„Ù…Ø´Ø§Ø¹Ø±! Ø£ÙƒØªØ¨ Ù‡Ø§ÙŠ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø¨Ø§Ù„Ø£Ù†ÙƒÙ„ÙŠØ²ÙŠ Ø¨ÙŠÙ† Ù‚ÙˆØ³ÙŠÙ† Ù‚Ø¨Ù„ Ø¬Ù…Ù„ØªÙƒ:\n\n"
             "ğŸ­ **Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…Ø´Ø§Ø¹Ø±:**\n"
             "â€¢ `[laugh]` : ÙŠØ¶Ø­Ùƒ ÙˆÙ‡Ùˆ ÙŠØ­Ø¬ÙŠ.\n"
             "â€¢ `[whisper]` : ÙŠÙ‡Ù…Ø³ Ø¨ØµÙˆØª Ù†Ø§ØµÙŠ.\n"
             "â€¢ `[angry]` : ÙŠØµÙŠØ­ Ø¨Ø¹ØµØ¨ÙŠØ©.\n"
             "â€¢ `[sad]` : ØµÙˆØªÙ‡ Ù…Ø®Ù†ÙˆÙƒ ÙˆØ­Ø²ÙŠÙ†.\n\n"
             "ğŸ“ **Ù…Ø«Ø§Ù„:**\n"
             "`[laugh] ÙˆÙ„Ùƒ Ù„Ø§ Ù…Ø³ØªØ­ÙŠÙ„! [whisper] Ø¨Ø³ Ø¯ÙŠØ± Ø¨Ø§Ù„Ùƒ ÙŠØ³Ù…Ø¹ÙˆÙƒ.`",
             reply_markup=get_back_btn(), parse_mode="Markdown"
         )

async def show_model_selection(q, mode):
    prefix = "set_model" if mode == "clone" else "use_model"
    return await q.message.edit_text(
        "âš™ï¸ **Ø£Ø®ØªØ§Ø± Ø§Ù„Ø¯Ù‚Ø© Ø§Ù„Ù„ÙŠ ØªØ¹Ø¬Ø¨Ùƒ:**",
        reply_markup=InlineKeyboardMarkup([
            [InlineKeyboardButton("âœ¨ v3 (Ø³Ø±ÙŠØ¹ + Ù…Ø´Ø§Ø¹Ø± Ø­Ù‚ÙŠÙ‚ÙŠØ©)", callback_data=f"{prefix}_v3")],
            [InlineKeyboardButton("ğŸ¤– v2 (Ø±Ø³Ù…ÙŠ ÙˆÙ…Ø³ØªÙ‚Ø±)", callback_data=f"{prefix}_v2")],
            [InlineKeyboardButton("ğŸ”™ Ø¥Ù„ØºØ§Ø¡", callback_data="back_home")]
        ]),
        parse_mode="Markdown"
    )

# ================= LOGIN CONVERSATION (Telethon) =================
# 1. Ø·Ù„Ø¨ Ø§Ù„Ø±Ù‚Ù…
async def telethon_start_handler(update: Update, ctx: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    await query.message.reply_text(
        "ğŸ“± **Ø±Ø¨Ø· Ø§Ù„Ø­Ø³Ø§Ø¨ (ØªÙØ¹ÙŠÙ„ Userbot)**\n\n"
        "Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ØµÙ…Ø§Øª Ù…Ù† Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø¨Ø§Ø´Ø±Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ **Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ** Ù…Ø¹ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„ÙŠ.\n\n"
        "ğŸ“ Ù…Ø«Ø§Ù„: `+9647700000000`\n\n"
        "ğŸ” **Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¢Ù…Ù†Ø©:** Ù†Ø³ØªØ®Ø¯Ù…Ù‡Ø§ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©.",
        reply_markup=get_back_btn(),
        parse_mode="Markdown"
    )
    return PHONE

# 2. Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ (Ù…Ø¹ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª)
async def login_phone(update: Update, ctx: ContextTypes.DEFAULT_TYPE):
    phone = update.message.text.strip().replace(" ", "")

    msg = await update.message.reply_text("â³ **Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø³ÙŠØ±ÙØ±Ø§Øª ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…...**", parse_mode="Markdown")

    client = TelegramClient(StringSession(), API_ID, API_HASH)
    await client.connect()

    if not await client.is_user_authorized():
        try:
            phone_code_hash = await client.send_code_request(phone)

            ctx.user_data['telethon_client'] = client
            ctx.user_data['phone'] = phone
            ctx.user_data['phone_code_hash'] = phone_code_hash.phone_code_hash

            # ğŸ”¥ğŸ”¥ğŸ”¥ Ø§Ù„ØªØ­Ø°ÙŠØ± Ø§Ù„Ù‡Ø§Ù… ğŸ”¥ğŸ”¥ğŸ”¥
            await msg.edit_text(
                "âœ… **ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯!**\n\n"
                "âš ï¸ **Ù‡Ø§Ù… Ø¬Ø¯Ø§Ù‹ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø­Ø¸Ø±:**\n"
                "Ø£Ø±Ø³Ù„ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø¹ **Ù…Ø³Ø§ÙØ§Øª** Ø¨ÙŠÙ† Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ù„ÙƒÙŠ ÙŠÙ‚Ø¨Ù„Ù‡ Ø§Ù„Ù†Ø¸Ø§Ù….\n"
                "âœ… **ØµØ­ÙŠØ­:** `1 2 3 4 5`\n"
                "âŒ **Ø®Ø·Ø£:** `12345`\n\n"
                "Ø£Ù†ØªØ¸Ø± Ø§Ù„ÙƒÙˆØ¯...",
                parse_mode="Markdown"
            )
            return CODE
        except Exception as e:
            await client.disconnect()
            await msg.edit_text(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±Ù‚Ù…: {e}", reply_markup=get_back_btn())
            return ConversationHandler.END
    else:
        await msg.edit_text("âš ï¸ Ø£Ù†Øª Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„ÙØ¹Ù„!", reply_markup=get_back_btn())
        await client.disconnect()
        return ConversationHandler.END

# 3. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ (Ù…Ø¹ Ø§Ù„ØªÙ†Ø¸ÙŠÙ)
async def login_code(update: Update, ctx: ContextTypes.DEFAULT_TYPE):
    # ğŸ”¥ ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† Ø§Ù„Ù…Ø³Ø§ÙØ§Øª ÙˆØ§Ù„Ø´Ø®Ø·Ø§Øª
    code = update.message.text.strip().replace(" ", "").replace("-", "")

    client = ctx.user_data['telethon_client']
    phone = ctx.user_data['phone']
    phone_code_hash = ctx.user_data['phone_code_hash']

    msg = await update.message.reply_text("â³ **Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...**")

    try:
        await client.sign_in(phone, code, phone_code_hash=phone_code_hash)

        session_string = client.session.save()
        db.update(update.effective_user.id, "session_string", session_string)
        await client.disconnect()

        await msg.edit_text(
            "ğŸ‰ **ØªÙ… Ø±Ø¨Ø· Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­!**\n\n"
            "Ù…ÙŠØ²Ø© **Userbot** Ù…ÙØ¹Ù„Ø© Ø§Ù„Ø¢Ù†.\n"
            "Ø£ÙŠ ØµÙˆØª ØªØ³ÙˆÙŠÙ‡ Ø±Ø§Ø­ ÙŠÙˆØµÙ„Ùƒ Ø¹Ù„Ù‰ 'Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©' Ù…Ø¨Ø§Ø´Ø±Ø©.",
            reply_markup=get_main_menu(db.get_user(update.effective_user.id)),
            parse_mode="Markdown"
        )
        return ConversationHandler.END

    except SessionPasswordNeededError:
        await msg.edit_text("ğŸ” **Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø­Ù…ÙŠ (2FA).**\nÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø­Ø³Ø§Ø¨Ùƒ.")
        return PASSWORD

    except PhoneCodeInvalidError:
        await msg.edit_text("âŒ Ø§Ù„ÙƒÙˆØ¯ ØºÙ„Ø· (ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ÙˆØ¶Ø¹Øª Ù…Ø³Ø§ÙØ§Øª). Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©.")
        return CODE 

    except Exception as e:
        await client.disconnect()
        await msg.edit_text(f"âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: {e}", reply_markup=get_back_btn())
        return ConversationHandler.END

# 4. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ (2FA)
async def login_password(update: Update, ctx: ContextTypes.DEFAULT_TYPE):
    password = update.message.text.strip()
    client = ctx.user_data['telethon_client']

    msg = await update.message.reply_text("â³ **Ø¬Ø§Ø±ÙŠ ÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ±...**")

    try:
        await client.sign_in(password=password)

        session_string = client.session.save()
        db.update(update.effective_user.id, "session_string", session_string)
        await client.disconnect()

        await msg.edit_text(
            "ğŸ‰ **ØªÙ… ÙØªØ­ Ø§Ù„Ù‚ÙÙ„ ÙˆØ±Ø¨Ø· Ø§Ù„Ø­Ø³Ø§Ø¨!**\nUserbot Active âœ…",
            reply_markup=get_main_menu(db.get_user(update.effective_user.id)),
            parse_mode="Markdown"
        )
        return ConversationHandler.END

    except Exception as e:
        await client.disconnect()
        await msg.edit_text(f"âŒ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ ØºÙ„Ø·: {e}", reply_markup=get_back_btn())
        return ConversationHandler.END

async def cancel_login(update: Update, ctx: ContextTypes.DEFAULT_TYPE):
    if 'telethon_client' in ctx.user_data:
        await ctx.user_data['telethon_client'].disconnect()
    await update.message.reply_text("âŒ ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡.", reply_markup=get_back_btn())
    return ConversationHandler.END

# ================= Handlers Normal =================
async def audio_handler(update: Update, ctx: ContextTypes.DEFAULT_TYPE):
    uid = update.effective_user.id
    user = db.get_user(uid)

    if "selected_model" not in ctx.user_data: return

    selected_model = ctx.user_data["selected_model"]
    del ctx.user_data["selected_model"] 
    display_model_name = "v3" if selected_model == MODEL_V3_INTERNAL else "v2"

    msg = await update.message.reply_text("â³ **Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ù†Ø¨Ø±Ø© Ø§Ù„ØµÙˆØª...**", parse_mode="Markdown")

    try:
        tg_file = await (update.message.voice or update.message.audio).get_file()
        file_path = f"{TMP}/{uid}_{int(time.time())}.wav"
        await tg_file.download_to_drive(file_path)

        final_wav = f"{TMP}/{uid}_final.wav"
        to_wav(file_path, final_wav)

        await msg.edit_text("ğŸ§¬ **Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„ØµÙˆØªÙŠØ©...**")
        voice_id = await create_voice(final_wav, f"User_{uid}")

        db.update(uid, "voice_id", voice_id)
        db.update(uid, "preview_count", user[4] + 1)

        await msg.edit_text(f"ğŸ™ï¸ **Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ¬Ø±Ø¨Ø© ({display_model_name})...**")
        audio = await tts(voice_id, PREVIEW_TEXT, selected_model)

        out_mp3 = f"{TMP}/{uid}_preview.mp3"
        with open(out_mp3, "wb") as f: f.write(audio)

        await msg.delete()

        caption = f"âœ… **ØªÙ… Ø§Ù„Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø¨Ù†Ø¬Ø§Ø­!**\nØ¬ÙˆØ¯Ø©: {display_model_name}"
        if user[3] == 1: caption += "\nğŸ”’ **ØªÙ… ØªØ«Ø¨ÙŠØª Ù‡ÙˆÙŠØªÙƒ Ø§Ù„ØµÙˆØªÙŠØ©.**"

        await update.message.reply_audio(audio=open(out_mp3, "rb"), caption=caption, reply_markup=get_back_btn(), parse_mode="Markdown")

    except Exception as e:
        await msg.edit_text(f"âŒ Ø­Ø¯Ø« Ø®Ø·Ø£:\n{str(e)}", reply_markup=get_back_btn(), parse_mode=None)

async def text_router(update: Update, ctx: ContextTypes.DEFAULT_TYPE):
    uid = update.effective_user.id
    user = db.get_user(uid)
    text = update.message.text.strip()

    if ctx.user_data.get("awaiting_code"):
        if not db.is_code_valid(text):
            return await update.message.reply_text("âŒ Ø§Ù„ÙƒÙˆØ¯ ØºÙ„Ø·ØŒ ØªØ£ÙƒØ¯ Ù…Ù†Ù‡.", reply_markup=get_back_btn())

        db.mark_code_used(text)
        db.activate_user(uid, START_CREDITS)

        # ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØµÙˆØª Ø§Ù„Ù‚Ø¯ÙŠÙ…
        if user[2]:
            try: await delete_voice_from_api(user[2])
            except: pass

        db.update(uid, "voice_id", None)
        ctx.user_data["awaiting_code"] = False
        user = db.get_user(uid)

        return await update.message.reply_text(
            f"ğŸ‰ **Ù…Ø¨Ø±ÙˆÙƒ Ø§Ù„ØªÙØ¹ÙŠÙ„ ÙŠØ§ Ø¨Ø·Ù„!**\n"
            f"ğŸ’° Ù†Ø²Ù„ Ø¨Ø­Ø³Ø§Ø¨Ùƒ: **5000 Ø­Ø±Ù**.\n"
            f"ØªÙ… ÙØªØ­ Ù…ÙŠØ²Ø© **Userbot** ğŸ“±.\n"
            f"Ù‡Ø³Ù‡ Ù„Ø§Ø²Ù… Ù†Ø³Ø¬Ù„ ØµÙˆØªÙƒ Ø§Ù„Ø¯Ø§Ø¦Ù…ÙŠ.. Ø£Ø¶ØºØ· Ø¹Ù„Ù‰ **'Ø§Ø³ØªÙ†Ø³Ø§Ø® ØµÙˆØªÙŠ'**.",
            reply_markup=get_main_menu(user),
            parse_mode="Markdown"
        )

    if ctx.user_data.get("awaiting_text"):
        ctx.user_data["awaiting_text"] = False

        if not user[2]:
            return await update.message.reply_text("âš ï¸ Ù…Ø§ Ø¹Ù†Ø¯Ùƒ ØµÙˆØª Ù…Ø­ÙÙˆØ¸ Ø¨Ø¹Ø¯Ùƒ.", reply_markup=get_back_btn())

        if len(text) > user[5]:
             return await update.message.reply_text("âŒ Ø±ØµÙŠØ¯Ùƒ Ø®Ù„ØµØŒ Ù„Ø§Ø²Ù… ØªØ´Ø­Ù†.", reply_markup=get_back_btn())

        selected_model = ctx.user_data.get("selected_model", MODEL_V2_INTERNAL)
        display_name = "v3" if selected_model == MODEL_V3_INTERNAL else "v2"

        msg = await update.message.reply_text(f"â³ **Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆÙ„ÙŠØ¯ ({display_name})...**", parse_mode="Markdown")
        try:
            audio = await tts(user[2], text, selected_model)
            db.deduct_credits(uid, len(text))

            out = f"{TMP}/{uid}_tts.mp3"
            with open(out, "wb") as f: f.write(audio)

            await msg.delete()

            # 1. Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙÙŠ Ø§Ù„Ø¨ÙˆØª (Ø·Ø¨ÙŠØ¹ÙŠ)
            await update.message.reply_audio(audio=open(out, "rb"), caption=f"âœ… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: {db.get_user(uid)[5]} Ø­Ø±Ù", reply_markup=get_back_btn())

            # 2. Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± Userbot (Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø±Ø¨ÙˆØ·Ø§Ù‹)
            if user[7]: # Ù„Ø¯ÙŠÙ‡ Ø¬Ù„Ø³Ø©
                 sent = await send_via_userbot(uid, out, text)
                 if sent:
                     await update.message.reply_text("ğŸ“± **ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù†Ø³Ø®Ø© Ù„Ø±Ø³Ø§Ø¦Ù„Ùƒ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©!**")

        except Exception as e:
            await msg.edit_text(f"âŒ Ø®Ø·Ø£:\n{str(e)}", reply_markup=get_back_btn(), parse_mode=None)

# ================= Admin Commands =================
async def gen(update: Update, ctx: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id not in ADMIN_IDS: return
    code = ''.join(secrets.choice(string.ascii_uppercase + string.digits) for _ in range(12))
    db.add_code(code)
    await update.message.reply_text(f"ğŸ”‘ `{code}`", parse_mode="Markdown")

async def reset_user(update: Update, ctx: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id not in ADMIN_IDS: return
    uid = update.effective_user.id
    db.reset_user_data(uid)
    await update.message.reply_text("âœ… Reset Done.")

async def clean_trash(update: Update, ctx: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id not in ADMIN_IDS: return
    status_msg = await update.message.reply_text("ğŸ§¹ **Ø¬Ø§Ø±ÙŠ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ø³Ø§Ø¨...**")
    rows = db.get_unpaid_voice_owners()
    if not rows: return await status_msg.edit_text("âœ… Ø§Ù„Ø­Ø³Ø§Ø¨ Ù†Ø¸ÙŠÙ.")
    c = 0
    for r in rows:
        if r[1]: 
            try: 
                await delete_voice_from_api(r[1])
                db.update(r[0], "voice_id", None)
                c+=1
            except: pass
    await status_msg.edit_text(f"âœ… **ØªÙ… Ø§Ù„ØªÙ†Ø¸ÙŠÙ!**\nØªÙ… Ø­Ø°Ù {c} ØµÙˆØª.")

if __name__ == "__main__":
    app = Application.builder().token(BOT_TOKEN).build()

    # Ù…Ø¹Ø§Ù„Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Conversation)
    login_handler = ConversationHandler(
        entry_points=[CallbackQueryHandler(telethon_start_handler, pattern="^telethon_start$")],
        states={
            PHONE: [MessageHandler(filters.TEXT & ~filters.COMMAND, login_phone)],
            CODE: [MessageHandler(filters.TEXT & ~filters.COMMAND, login_code)],
            PASSWORD: [MessageHandler(filters.TEXT & ~filters.COMMAND, login_password)],
        },
        fallbacks=[CommandHandler("cancel", cancel_login)]
    )

    app.add_handler(login_handler)

    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("gen", gen))
    app.add_handler(CommandHandler("reset", reset_user))
    app.add_handler(CommandHandler("clean_trash", clean_trash))
    app.add_handler(CallbackQueryHandler(buttons))
    app.add_handler(MessageHandler(filters.VOICE | filters.AUDIO, audio_handler))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, text_router))

    print("Bot Started...")
    app.run_polling(drop_pending_updates=True)
